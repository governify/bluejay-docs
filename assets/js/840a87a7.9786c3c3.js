"use strict";(self.webpackChunkbluejay_docs=self.webpackChunkbluejay_docs||[]).push([[6869],{3314:(e,t,n)=>{n.d(t,{A:()=>s});const s="data:image/png;base64,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DQkGJYcOvV/zi3pB15C3WF7nFGCVn6u3oelPDq96tU1sXcOmXhaGI0LtBhaOLGsc4LlHoreszgTXwzYQEQ0CAzMs5RAsHJ6hUbkddYYifGI353oUUhdQ74zyDMl603qtaviyx2SPzD28+jPoQ7nd0UPT81l/Fn3YOj6la4VpIFqv2imHuo21/Ff/gcS8w+TVs9R7xDfe1yBtuNiGzugJ6n7LIXX/eVwiooFnxK+7wEcu7Lkfd6gjzfeN+E/tRfyoDntCW+wypt63hycXmdzdJMpafRaUaNyLcjx1uusZigez9xCi+zVi13dxjVrActG90OUCEtUCo9PmeXgKp/ShXb9FL+4FLPJanjra4he/xUndLQzyX/Di1bbAurm2h++im64FQ4HvwQ2LbqRuFid11jnQEh+Geq/5Vu9rdi3kCdQG74U/okzO9wb8mhER3XzdLfD5lcPyJrghEOXD2oRr/qs6qRvyXk3wCjoiIvI3NP4/S20IdLpaOCK36UAVg5KIiPrO4OtZEhER9aGh0bMkIiK6yRiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREBhiWREREQQH/B/l7CcB589gIAAAAAElFTkSuQmCC"},3381:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/load-script-7a674838c769f03854b2998621020abe.png"},8152:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"development/extending-bluejay/custom-tasks/create-or-update-tpa","title":"Create or Update TPA","description":"Create or Update TPA","source":"@site/docs/development/extending-bluejay/custom-tasks/create-or-update-tpa.md","sourceDirName":"development/extending-bluejay/custom-tasks","slug":"/development/extending-bluejay/custom-tasks/create-or-update-tpa","permalink":"/next/development/extending-bluejay/custom-tasks/create-or-update-tpa","draft":false,"unlisted":false,"editUrl":"https://github.com/governify/bluejay-docs/edit/main/docs/development/extending-bluejay/custom-tasks/create-or-update-tpa.md","tags":[],"version":"current","lastUpdatedBy":"Daniel Galv\xe1n Cancio","lastUpdatedAt":1748074055000,"sidebarPosition":4,"frontMatter":{"title":"Create or Update TPA","description":"Create or Update TPA","sidebar_position":4,"hide_table_of_contents":false,"keywords":["TPA creation","TPA update","Bluejay","createOrUpdateClassTPA","Governify custom tasks","TPA script","agreement management","TPA templates","task runner","project agreements","script configuration","replace TPA","create TPA","assets-bluejay","registry service","technical implementation"]},"sidebar":"defaultSidebar","previous":{"title":"Scope-Manager","permalink":"/next/development/setup-development-environment/nodejs/scopes-manager"},"next":{"title":"Optimize Calculation Period","permalink":"/next/development/extending-bluejay/custom-tasks/optimize-calculation-period"}}');var i=n(4848),r=n(8453);const a={title:"Create or Update TPA",description:"Create or Update TPA",sidebar_position:4,hide_table_of_contents:!1,keywords:["TPA creation","TPA update","Bluejay","createOrUpdateClassTPA","Governify custom tasks","TPA script","agreement management","TPA templates","task runner","project agreements","script configuration","replace TPA","create TPA","assets-bluejay","registry service","technical implementation"]},o="Update TPA for a class",c={},l=[{value:"Load Optimize Calculation Period",id:"load-optimize-calculation-period",level:2},{value:"Configure the script",id:"configure-the-script",level:2},{value:"Configuration example",id:"configuration-example",level:3},{value:"Replace",id:"replace",level:4},{value:"Create",id:"create",level:4},{value:"Run the script",id:"run-the-script",level:2},{value:"Technical details",id:"technical-details",level:2}];function d(e){const t={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"update-tpa-for-a-class",children:"Update TPA for a class"})}),"\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsx)(t.p,{children:"Bluejay allows you to create new TPAs \u200b\u200bfor uncreated projects from templates or update the TPAs \u200b\u200bof projects that have already been created."}),"\n",(0,i.jsx)(t.p,{children:"For this, the TPA creation or update script is used. This script allows you to do 2 actions:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Create a tpa for an uncreated project"})," from a template."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Update the TPAs of a set of projects"})," that must include a given chain fragment. All those that meet this criterion will be updated with the TPA from the specified template."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["This script is one of the ",(0,i.jsx)(t.a,{href:"https://docs.governify.io/development/extending-governify/custom-tasks",children:"Custom Tasks of Extending Governify"}),", and it is stored within the assets-bluejay repository ",(0,i.jsx)(t.a,{href:"https://github.com/governify/assets-bluejay/blob/main/public/director/tasks/utils/createOrUpdateClassTPA/script.js",children:"(link)"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"In this document, we will discuss how to load, configure, and run the script from the user interface. If you want to see the inner workings of this script, we will provide an explanation of the technical details in the last section."}),"\n",(0,i.jsx)(t.h2,{id:"load-optimize-calculation-period",children:"Load Optimize Calculation Period"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Go to  ",(0,i.jsx)(t.em,{children:(0,i.jsx)(t.strong,{children:"ui.bluejay.[YourDomain]"})})]}),"\n",(0,i.jsx)(t.li,{children:"Click on Admin UI"}),"\n",(0,i.jsx)(t.li,{children:"Click on the Task Runner tab"}),"\n",(0,i.jsxs)(t.li,{children:["Open the dropdown and select ",(0,i.jsx)(t.strong,{children:"createOrUpdateClassTPA."})]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"load script",src:n(3381).A+"",width:"1295",height:"341"})}),"\n",(0,i.jsx)(t.h2,{id:"configure-the-script",children:"Configure the script"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"template"}),": ",(0,i.jsx)(t.em,{children:"string"}),"."]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"A string representing the TPA template to use. This template must be stored in the assets-manager, within public/renders/tpa. The string will be the name of the file without including the .json ending."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"mode"}),": ",(0,i.jsx)(t.em,{children:"string"}),"."]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"A string representing replace or create, depending on whether we want to replace a TPA for an already created project or create a TPA for an uncreated project."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"agreementId"}),": ",(0,i.jsx)(t.em,{children:"string"}),"."]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"A string representing the projectId of the project that you want to update or create. In case of replacement, a regexp is used and all projects that comply with the chain will be updated with the new TPA. In case of creating, the specific projectId of the project must be entered."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"classId"}),": ",(0,i.jsx)(t.em,{children:"string"}),"."]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"Only used in create. A string representing the classId of the class to which the project we want to create belongs."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"configuration-example",children:"Configuration example"}),"\n",(0,i.jsx)(t.h4,{id:"replace",children:"Replace"}),"\n",(0,i.jsx)(t.p,{children:'Replacing the TPA of all projects that contain "showcase" in their projectId with the template called "template".'}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{\n  "template": "template",\n  "mode": "replace",\n  "agreementId": "showcase"\n}\n'})}),"\n",(0,i.jsx)(t.h4,{id:"create",children:"Create"}),"\n",(0,i.jsx)(t.p,{children:'Creating a new TPA with the template called "template" for the project with projectId "showcase-GH-governify_bluejay-showcase" belonging to the class with classId "showcase".'}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{\n  "template": "template",\n  "mode": "create",\n  "agreementId": "showcase-GH-governify_bluejay-showcase",\n  "classId": "showcase"\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"run-the-script",children:"Run the script"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Click run"})," and you will see the results in the log of ",(0,i.jsx)(t.strong,{children:"Result.json."})]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"load script",src:n(3314).A+"",width:"459",height:"71"})}),"\n",(0,i.jsx)(t.admonition,{title:"bear in mind",type:"info",children:(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"You will be notified with an error if any field is wrong or with a success message if it has been executed correctly."}),"\n"]})}),"\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsx)(t.h2,{id:"technical-details",children:"Technical details"}),"\n",(0,i.jsxs)(t.p,{children:["This section explains line by line the ",(0,i.jsx)(t.strong,{children:"createOrUpdateClassTPA"})," ",(0,i.jsx)(t.a,{href:"https://github.com/governify/assets-bluejay/blob/main/public/director/tasks/utils/createOrUpdateClassTPA/script.js",children:"script.js"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Imports:"})," axios and governify commons to be able to make requests to the endpoints."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",metastring:"showLineNumbers",children:"\"use strict\";\nconst governify = require('governify-commons');\nconst axios = require('axios');\n"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Checks:"})," Checking that all specified parameters are correct."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",metastring:"showLineNumbers",children:'module.exports.main = async (config) => {\n\n    // Checkers\n    if (!config.template) return "Missing template parameter";\n    if (!config.agreementId) return "Missing agreementId parameter";\n    if (!config.mode) return "Missing mode parameter";\n    if (config.mode === "create" && !config.classId) return "Missing classId parameter for create mode";\n\n    const assetsUrl = `${governify.infrastructure.getServiceURL("internal.assets")}/api/v1/public/renders/tpa/`;\n    const registryUrl = `${governify.infrastructure.getServiceURL("internal.registry")}/api/v6/agreements`;\n    const templateUrl = (config.template.startsWith("http") ? "" : assetsUrl) + (config.template.includes(".json") ? config.template : `${config.template}.json`);\n\n    const template = await axios.get(templateUrl).then(res => res.data).catch(() => {});\n    if (!template) return "Error getting template file";\n'})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Creating or Updating the TPA:"})," creates or replaces the TPA using the specified template for the indicated project or projects."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",metastring:"showLineNumbers",children:'    if (config.mode === "create") {\n        const tpa = JSON.stringify(template).replace(/1010101010/g, config.agreementId).replace(/2020202020/g, config.classId);\n        return await axios.post(`${registryUrl}`, JSON.parse(tpa)).then(() => "Agreement created").catch(() => "Error creating agreement");\n    } else if (config.mode === "replace") {\n        const tpas = await axios.get(`${registryUrl}`).then(res => res.data?.filter(t => new RegExp(config.agreementId).test(t.id)) ?? []).catch(() => []);\n        const errors = [];\n\n        for (const tpa of tpas) {\n            await axios.delete(`${registryUrl}/${tpa.id}`).then(() => {\n                const tpaId = tpa.id.replace("tpa-", "");\n                const classId = tpa.context.definitions.scopes.development.class.default;\n                const newTpa = JSON.parse(JSON.stringify(template).replace(/1010101010/g, tpaId).replace(/2020202020/g, classId));\n                return axios.post(`${registryUrl}`, newTpa).catch(() => errors.push(`Error on creation while replacing agreement ${tpa.id}`));\n            }).catch(() => errors.push(`Error on deletion while replacing agreement ${tpa.id}`));            \n        }\n\n        if (errors.length > 0) return "ERRORS:\\n" + errors.join("\\n");\n        else return "Agreements replaced";\n\n    } else {\n        return "Invalid mode parameter (create|replace)";\n    }\n}\n'})})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>o});var s=n(6540);const i={},r=s.createContext(i);function a(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);